# Refactor Report (2026-02-09)

這份文件記錄本次長任務重構內容、修復點、風險處理與驗證結果。

## 1) 目標

- 降低後端 API 重複邏輯與一致性風險
- 強化 key/path 安全與 metadata 正規化
- 收斂前端重複 request pattern，減少 silent failure
- 保持既有功能與部署方式不破壞

---

## 2) 後端重構

### 2.1 Auth 機制統一與強化

**新增：** `functions/_utils/auth.js`

- 提供 `authenticateRequest()` 作為全部 API 共用入口
- 新 token 改為 `HMAC-SHA256` 簽章（v2 payload）
- 支援與舊 token 相容驗證（legacy fallback）
- 加入常見安全細節：
  - base64url payload/signature
  - timing-safe compare
  - token payload 結構與 `exp` 嚴格檢查
- 保留 `DEV_BYPASS_AUTH` 開發模式行為

**套用範圍：**

- `functions/api/auth/verify.js`
- `functions/api/images*.js`
- `functions/api/folders.js`
- `functions/api/metadata*.js`
- `functions/api/upload.js`
- `functions/api/shares.js`
- `functions/api/logs.js`
- `functions/api/monitoring/r2.js`
- `functions/api/maintenance/*.js`

> 結果：移除每支 route 內嵌重複 `verifyToken/authenticate`，降低邏輯分叉與漏改風險。

### 2.2 Key / 路徑安全統一

**新增：** `functions/_utils/keys.js`

- 統一 key sanitize / folder normalize
- 針對保留路徑（`.config` / `.thumbs`）提供可重用判斷
- 新增 upload key 安全檢查（允許 thumbnails 的特例）
- 新增 `isHiddenObjectKey` / `isTrashKey` 幫助 list/filter 一致化

**修復重點：**

- `/api/file` 增加 key 合法性檢查（避免 path traversal 類風險）
- `/api/upload` 的 folder / file name / custom key 統一 sanitize
- `move/rename/share` 類 API 的 key 清理與保留路徑防護

### 2.3 Metadata 工具層正規化

**修改：** `functions/_utils/meta.js`

- 新增各類 meta 的 normalize 函式
  - `imageMeta/hashMeta/shareMeta/folderMeta/maintenanceMeta`
- 防止 R2 上壞資料造成 runtime 結構異常
- 新增 `listObjectsPage()`（為後續分頁/流式擴展做基礎）

### 2.4 API 一致性清理

在 route 層統一以下模式：

- `await authenticateRequest(...)` 做授權
- request key/folder 先 sanitize 再處理
- hidden/reserved object 以共用 helper 過濾
- 錯誤回傳保持原語意，避免前端破壞

---

## 3) 前端重構

### 3.1 API 呼叫集中化

**新增：** `src/utils/api.ts`

- `apiRequest()` 統一：
  - Authorization token 注入
  - JSON body 與 header 自動處理
  - 錯誤統一拋 `ApiError(status, message)`
  - response parsing 支援 `json/text/blob/auto`

**改造元件：**

- `src/contexts/ImageMetaContext.tsx`
- `src/components/BulkMoveModal.tsx`
- `src/components/BulkRenameModal.tsx`
- `src/components/ShareModal.tsx`
- `src/components/ShareManagerModal.tsx`
- `src/components/AdminToolsModal.tsx`
- `src/components/FolderNav.tsx`
- `src/components/ImageGrid.tsx`
- `src/pages/Admin.tsx`

> 結果：移除大量重複 `fetch + token + res.ok` 樣板碼，錯誤顯示更一致。

### 3.2 URL / domain 決策集中

**新增：** `src/utils/url.ts`

- 統一 delivery domain 常數
- 統一 share origin 判斷
- 統一 file/download proxy 判斷

**套用：**

- `ShareModal`
- `ShareManagerModal`
- `Share page`
- `ImageGrid`

### 3.3 Key 輕量工具

**新增：** `src/utils/key.ts`

- 先提供 `normalizeFolderPath()`，減少上傳路徑中重複 slash 與前後 `/`

### 3.4 UI/互動健壯性改善

- `FolderNav` / `ImageGrid` 增加 inline 錯誤提示
- 批次操作與 context 操作遇到 API 錯誤時不再完全 silent
- 維持原本 UX（包含 prompt/confirm 流程）以避免行為突變

### 3.5 前端全面重構（第二輪）

本輪在既有重構基礎上，再做一次前端「全域掃描 + 共用層抽取 + 大型元件穩定化」。

**新增共用工具與 hook：**

- `src/utils/format.ts`
  - 統一 `formatBytes()` / `formatDateShort()`
  - 新增 `normalizeDownloadName()`，避免各處重複 regex
- `src/utils/storage.ts`
  - 統一 local/session storage 讀寫與 fallback
  - 避免各檔案散落 try/catch 與搬移 session→local 邏輯
- `src/hooks/useTransientMessage.ts`
  - 統一短暫提示訊息（自動消失 + 清理 timer）
  - 取代各元件重複 `setTimeout` pattern

**全域套用與整理：**

- `AuthContext`：改用 `apiRequest` + `storage utils`，移除重複 storage 存取程式碼
- `Header` / `Admin` / `Uploader`：改用 `storage utils` 統一偏好設定寫法
- `ImageGrid` / `FolderNav` / `ShareModal` / `ShareManagerModal`：改用 `useTransientMessage`
- `AdminToolsModal` / `ImageGrid` / `Share`：改用 `format utils`，移除重複格式化函式
- `Share`：補上 API response typing 與下載進度顯示（`x/y`）
- `ImageGrid`：
  - 修正虛擬清單與 grid 列高不一致導致卡片重疊
  - 改為動態 row height 計算與固定欄數渲染
- `App`：抽出 `resolveRoute()`，簡化路由判斷

**前端結果：**

- 前端直接 `fetch` 目前只保留必要情境：
  - 無需 auth 的 `/api/share/:id`
  - 上傳流程（FormData + 串流）
  - zip 下載工具
- 可維護性提升：跨元件重複邏輯（格式化、storage、短暫訊息）已集中
- 行為穩定性提升：卡片重疊問題修復，下載/錯誤訊息更明確

---

## 4) 修復的具體隱患（摘要）

- **重複 auth 實作分散** → 已統一，避免未來出現 route 漏修
- **舊 token 簽章過弱** → 升級 HMAC，保留 legacy 驗證相容
- **多處 key/path 缺乏一致 sanitize** → 已集中工具處理
- **API 錯誤大量被忽略**（前端）→ 關鍵路徑加入一致錯誤回報
- **metadata 讀取對壞資料容錯不足** → normalize 強化
- **share/item 來源混雜且重複判斷** → item sanitize 與 hidden object 過濾統一

---

## 5) 驗證結果

已執行：

- `npm run type-check` ✅
- `npm run build` ✅

目前專案可正常通過 TypeScript 與 production build。

補充：第二輪前端全面重構後，再次執行相同驗證，結果皆通過。

---

## 6) 本次變更檔案（重點）

### 新增

- `functions/_utils/auth.js`
- `functions/_utils/keys.js`
- `src/utils/api.ts`
- `src/utils/url.ts`
- `src/utils/key.ts`
- `src/utils/format.ts`
- `src/utils/storage.ts`
- `src/hooks/useTransientMessage.ts`
- `docs/REFACTOR-2026-02-09.md`

### 主要修改（摘錄）

- `functions/_utils/meta.js`
- `functions/api/auth.js`
- `functions/api/file.js`
- `functions/api/folders.js`
- `functions/api/images.js`
- `functions/api/images/batch.js`
- `functions/api/images/move.js`
- `functions/api/images/rename.js`
- `functions/api/metadata.js`
- `functions/api/metadata/batch.js`
- `functions/api/shares.js`
- `functions/api/share/[id].js`
- `functions/api/upload.js`
- `functions/api/logs.js`
- `functions/api/monitoring/r2.js`
- `functions/api/maintenance/*.js`
- `src/components/*`（多個核心元件）
- `src/contexts/ImageMetaContext.tsx`
- `src/pages/Admin.tsx`
- `src/pages/Share.tsx`

---

## 7) 後續建議（下一步）

- ~~補上 `eslint`（目前 scripts 有 lint 指令但未安裝 eslint）~~ ✅ 已完成
- ~~為 API utils 加最小單元測試（auth/token、keys sanitize）~~ ✅ 已完成
- ~~規劃去除 `prompt/alert/confirm`，改一致 Modal UX~~ ✅ 已完成
- 將 `R2` 相關操作抽 service 層，進一步降低 route 體積（已有基礎 `r2.js`）

---

## 8) 第三輪改動（2026-02-09 下午）

### 8.1 原生對話框替換

將所有 `prompt()` / `confirm()` 替換為自訂 Modal：

- 新增 `src/hooks/useDialogs.ts`（`useConfirmDialog` / `usePromptDialog`）
- 更新 `ImageGrid.tsx`、`FolderNav.tsx`、`ShareManagerModal.tsx`
- 使用 `ConfirmModal` / `TextPromptModal` 組件

### 8.2 前端 Key 工具整合

- 新增 `src/utils/keys.ts`（與後端 `keys.js` 保持一致）
- 移除重複的 `key.ts` / `sanitize.ts`

### 8.3 工具鏈強化

- 安裝並配置 `husky` + `lint-staged`
- Pre-commit hook：eslint --fix + type-check
- 新增 `.github/pull_request_template.md`

### 8.4 文件補齊

- `docs/TS-MIGRATION.md`：JS → TS 遷移路線
- `docs/ENV.md`：環境變數說明
- `docs/TROUBLESHOOTING.md`：故障排查手冊

### 8.5 驗證

- `npm run type-check` ✅
- `npm run build` ✅
- `npm run test` ✅ (16 tests passed)

